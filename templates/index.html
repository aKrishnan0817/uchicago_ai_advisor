<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UChicago Academic Advisor</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>
</head>
<body>
    <div class="chat-container">
        <header>
            <div class="header-top">
                <h1>UChicago Academic Advisor</h1>
            </div>
            <div class="info-bar">
                <span class="badge" id="data-badge">Loading data...</span>
                <span class="badge" id="transcript-badge">No transcript uploaded</span>
            </div>
        </header>

        <div id="messages" class="messages">
            <div class="message assistant">
                <div class="avatar">A</div>
                <div class="bubble">
                    Hi! I'm your UChicago academic advisor chatbot. I can help you with questions about major and minor requirements, course planning, and more. What would you like to know?
                </div>
            </div>
        </div>

        <div id="upload-zone" class="upload-zone hidden">
            <div class="upload-area" id="drop-area">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                <p>Drop your transcript here or <label for="file-input" class="file-label">browse</label></p>
                <p class="upload-hint">Supports .txt and .csv files with course codes (e.g., CMSC 14100)</p>
                <input type="file" id="file-input" accept=".txt,.csv" hidden>
            </div>
        </div>

        <form id="chat-form" class="input-area">
            <button type="button" id="upload-btn" class="icon-btn" title="Upload transcript">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
                </svg>
            </button>
            <input
                type="text"
                id="user-input"
                placeholder="Ask about majors, courses, requirements..."
                autocomplete="off"
                required
            />
            <button type="submit" id="send-btn" class="icon-btn send" title="Send message">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"/>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                </svg>
            </button>
        </form>
    </div>

    <script>
        const messagesEl = document.getElementById('messages');
        const form = document.getElementById('chat-form');
        const input = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const uploadBtn = document.getElementById('upload-btn');
        const uploadZone = document.getElementById('upload-zone');
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('file-input');
        const dataBadge = document.getElementById('data-badge');
        const transcriptBadge = document.getElementById('transcript-badge');

        let history = [];
        let completedCourses = [];

        // --- Markdown rendering ---
        function renderMarkdown(text) {
            const html = marked.parse(text);
            return DOMPurify.sanitize(html);
        }

        // --- Messages ---
        function addMessage(role, text) {
            const div = document.createElement('div');
            div.className = `message ${role}`;

            if (role === 'assistant') {
                const avatar = document.createElement('div');
                avatar.className = 'avatar';
                avatar.textContent = 'A';
                div.appendChild(avatar);
            }

            const bubble = document.createElement('div');
            bubble.className = 'bubble';

            if (role === 'assistant') {
                bubble.innerHTML = renderMarkdown(text);
            } else {
                bubble.textContent = text;
            }

            div.appendChild(bubble);
            messagesEl.appendChild(div);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        // --- Typing indicator ---
        function showTypingIndicator() {
            const div = document.createElement('div');
            div.className = 'message assistant typing-indicator-msg';
            div.id = 'typing-indicator';

            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.textContent = 'A';
            div.appendChild(avatar);

            const bubble = document.createElement('div');
            bubble.className = 'bubble typing-bubble';
            bubble.innerHTML = '<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>';
            div.appendChild(bubble);

            messagesEl.appendChild(div);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function removeTypingIndicator() {
            const el = document.getElementById('typing-indicator');
            if (el) el.remove();
        }

        // --- Status fetch ---
        fetch('/status')
            .then(r => r.json())
            .then(data => {
                dataBadge.textContent = `${data.program_count} programs, ${data.course_count} courses loaded`;
                dataBadge.classList.add('loaded');
            })
            .catch(() => {
                dataBadge.textContent = 'Data unavailable';
            });

        // --- Upload handling ---
        uploadBtn.addEventListener('click', () => {
            uploadZone.classList.toggle('hidden');
        });

        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.classList.add('drag-over');
        });

        dropArea.addEventListener('dragleave', () => {
            dropArea.classList.remove('drag-over');
        });

        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.classList.remove('drag-over');
            if (e.dataTransfer.files.length) {
                handleFileUpload(e.dataTransfer.files[0]);
            }
        });

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length) {
                handleFileUpload(fileInput.files[0]);
            }
        });

        async function handleFileUpload(file) {
            const formData = new FormData();
            formData.append('file', file);

            transcriptBadge.textContent = 'Uploading...';
            transcriptBadge.classList.remove('uploaded');

            try {
                const resp = await fetch('/upload-transcript', {
                    method: 'POST',
                    body: formData,
                });
                const data = await resp.json();

                if (data.error) {
                    transcriptBadge.textContent = 'Upload failed';
                    addMessage('assistant', `Could not parse transcript: ${data.error}`);
                } else {
                    completedCourses = data.courses;
                    transcriptBadge.textContent = `${completedCourses.length} courses from transcript`;
                    transcriptBadge.classList.add('uploaded');
                    uploadZone.classList.add('hidden');
                    addMessage('assistant',
                        `Transcript uploaded! I found **${completedCourses.length} courses**: ${completedCourses.join(', ')}.\n\nI'll reference these when advising you. Ask me what you should take next!`
                    );
                }
            } catch (err) {
                transcriptBadge.textContent = 'Upload failed';
                addMessage('assistant', 'Error: Could not upload transcript. Please try again.');
            }

            fileInput.value = '';
        }

        // --- Chat ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = input.value.trim();
            if (!message) return;

            addMessage('user', message);
            input.value = '';
            sendBtn.disabled = true;
            showTypingIndicator();

            try {
                const resp = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message,
                        history,
                        completed_courses: completedCourses,
                    }),
                });
                const data = await resp.json();

                removeTypingIndicator();

                if (data.error) {
                    addMessage('assistant', `Error: ${data.error}`);
                } else {
                    addMessage('assistant', data.reply);
                    history.push({ role: 'user', content: message });
                    history.push({ role: 'assistant', content: data.reply });
                    if (history.length > 20) {
                        history = history.slice(-20);
                    }
                }
            } catch (err) {
                removeTypingIndicator();
                addMessage('assistant', 'Error: Could not reach the server.');
            }

            sendBtn.disabled = false;
            input.focus();
        });
    </script>
</body>
</html>
